<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Ball</title>
</head>
<body>

    <style>
        canvas {
            border: 1px solid black;
        }
    </style>

    <canvas id="can"></canvas>

    <script>
        let canvas = document.getElementById("can");


        const G = 9.8;
        const Y_DIR = -1; //1 - positive Y direction, -1 - negative direction
        const START_SPEED =  90;
        const START_ANGLE = 45;
        const FPS = 1;


        canvas.width = 500; //window.innerWidth - 100;
        canvas.height = window.innerHeight - 100;

        let context = canvas.getContext("2d");
        let centerX = 250;
        let centerY = 250;
        let radius = 20;

        class Vector {
            constructor(v, angle) {
                this.v = v;
                this.a = angle * (Math.PI / 180);
            }
        }

        class Ball {
            constructor(x, y, r, velocity) {
                this.x = x;
                this.y = y;
                this.r = r;
                this.velocity = velocity;

                this.t0 = Date.now();
                this.x0 = x;
                this.y0 = y;
            }

            draw(context) {
                circle(context, this.x, this.y, this.r);
            }

            currentVelocity() {
                let v0 = this.velocity.v;
                let t = (Date.now() - this.t0) / 100;
                let alpha = this.velocity.a;

                return Math.sqrt(Math.pow(v0, 2) - 2 * v0 * G * t * Math.sin(alpha) + Math.pow(G * t, 2));
            }

            currentAngle() {
                let v0 = this.velocity.v;
                let t = (Date.now() - this.t0) / 100;
                let alpha = this.velocity.a;

                //console.log("currentAngle", v0, t, alpha*180/Math.PI, Math.cos(alpha));

                let angle = Math.atan((v0 * Math.sin(alpha) - G * t) / (v0 * Math.cos(alpha)));
                if (Math.cos(alpha) < 0.0001 || Math.cos(alpha)> -0.0001) {return alpha;}
                if (Math.cos(alpha) < 0) {
                    angle += Math.PI;
                }

                return angle;
            }

            bounce(angle) {
                this.velocity.v = this.currentVelocity();
                this.velocity.a = 2 * Math.PI - this.currentAngle() + 2 * Math.atan(angle);

                this.t0 = Date.now();
                this.x0 = this.x;
                this.y0 = this.y;
            }

            collides(another) {
                let distance = Math.sqrt(Math.pow(this.x - another.x, 2) + Math.pow(this.y - another.y, 2));

                return distance <= this.r + another.r;
            }

            move() {
                let v0 = this.velocity.v;
                let alpha = this.velocity.a;

                let t = (Date.now() - this.t0) / 100;

                this.x = this.x0 + v0 * t * Math.cos(alpha);
                this.y = this.y0 + Y_DIR * (v0 * t * Math.sin(alpha) - 0.5 * G * Math.pow(t, 2));

                let angle = Math.atan((v0 * Math.sin(alpha) - G * t) / (v0 * Math.cos(alpha)));
                if (Math.cos(alpha) < 0) {
                    angle += Math.PI;
                }

                if ((this.x + this.r >= context.canvas.width && Math.cos(alpha) > 0)
                        || (this.x - this.r <= 0 && Math.cos(alpha) < 0)) {

                    this.bounce();
                    this.velocity.a = Math.PI - angle;

                } else if ((this.y - this.r <= 0 && Y_DIR * Math.sin(angle) < 0) || (
                        this.y + this.r >= context.canvas.height && Y_DIR * Math.sin(angle) > 0)) {

                    this.bounce(0);
                }
            }
        }

        function circle(context, x, y, r) {
            context.beginPath();
            context.arc(x, y, r, 0, 2 * Math.PI, false);
            context.fillStyle = 'green';
            context.fill();
        }

        let v = new Vector(50, 135);
        let v1 = new Vector(100, 45);
        let v2 = new Vector(50, 0);
        let balls = [new Ball(centerX - 50, centerY, radius, v),
            new Ball(centerX, centerY, radius, v1),
            new Ball(centerX + 50, centerY, radius, v2)
        ];

        let intervalId = setInterval(function() {
            context.clearRect(0, 0, context.canvas.width, context.canvas.height);

            balls.forEach(function(ball) {
               for (let another of balls) {
                   if (another == ball) return;

                   let k = Math.atan((ball.y - another.y) / (another.x - ball.x));
                   let normal = k > 0 ? k - Math.PI / 2 : k + Math.PI / 2;

                   if (ball.collides(another)) {

                       another.bounce(normal);
                       ball.bounce(normal);

                       while (ball.collides(another)) {
                           ball.move();
                           another.move()
                       }
                   }
               }
            });

            context.clearRect(0, 0, context.canvas.width, context.canvas.height);


            balls.forEach(function(ball) {
                ball.move();
                ball.draw(context);
            });
        }, FPS);

        canvas.addEventListener('click', function() {clearInterval(intervalId)});
    </script>



</body>
</html>